/*
 Copyright (c) 2003-2017, CKSource - Frederico Knabben. All rights reserved.
 For licensing, see LICENSE.md or http://ckeditor.com/license
*/
(function(){function n(d){1>arguments.length||(this.range=d,this.forceBrBreak=0,this.enlargeBr=1,this.enforceRealBlocks=0,this._||(this._={}))}function u(d){var a=[];d.forEach(function(b){if("true"==b.getAttribute("contenteditable"))return a.push(b),!1},CKEDITOR.NODE_ELEMENT,!0);return a}function r(d,a,b,f){a:{null==f&&(f=u(b));for(var g;g=f.shift();)if(g.getDtd().p){f={element:g,remaining:f};break a}f=null}if(!f)return 0;if((g=CKEDITOR.filter.instances[f.element.data("cke-filter")])&&!g.check(a))return r(d,
a,b,f.remaining);a=new CKEDITOR.dom.range(f.element);a.selectNodeContents(f.element);a=a.createIterator();a.enlargeBr=d.enlargeBr;a.enforceRealBlocks=d.enforceRealBlocks;a.activeFilter=a.filter=g;d._.nestedEditable={element:f.element,container:b,remaining:f.remaining,iterator:a};return 1}function t(d,a,b){if(!a)return!1;d=d.clone();d.collapse(!b);return d.checkBoundaryOfElement(a,b?CKEDITOR.START:CKEDITOR.END)}var v=/^[\r\n\t ]+$/,p=CKEDITOR.dom.walker.bookmark(!1,!0),w=CKEDITOR.dom.walker.whitespaces(!0),
x=function(d){return p(d)&&w(d)},y={dd:1,dt:1,li:1};n.prototype={getNextParagraph:function(d){var a,b,f,g,m;d=d||"p";if(this._.nestedEditable){if(a=this._.nestedEditable.iterator.getNextParagraph(d))return this.activeFilter=this._.nestedEditable.iterator.activeFilter,a;this.activeFilter=this.filter;if(r(this,d,this._.nestedEditable.container,this._.nestedEditable.remaining))return this.activeFilter=this._.nestedEditable.iterator.activeFilter,this._.nestedEditable.iterator.getNextParagraph(d);this._.nestedEditable=
null}if(!this.range.root.getDtd()[d])return null;if(!this._.started){var e=this.range.clone();b=e.startPath();var c=e.endPath(),h=!e.collapsed&&t(e,b.block),q=!e.collapsed&&t(e,c.block,1);e.shrink(CKEDITOR.SHRINK_ELEMENT,!0);h&&e.setStartAt(b.block,CKEDITOR.POSITION_BEFORE_END);q&&e.setEndAt(c.block,CKEDITOR.POSITION_AFTER_START);b=e.endContainer.hasAscendant("pre",!0)||e.startContainer.hasAscendant("pre",!0);e.enlarge(this.forceBrBreak&&!b||!this.enlargeBr?CKEDITOR.ENLARGE_LIST_ITEM_CONTENTS:CKEDITOR.ENLARGE_BLOCK_CONTENTS);
e.collapsed||(b=new CKEDITOR.dom.walker(e.clone()),c=CKEDITOR.dom.walker.bookmark(!0,!0),b.evaluator=c,this._.nextNode=b.next(),b=new CKEDITOR.dom.walker(e.clone()),b.evaluator=c,b=b.previous(),this._.lastNode=b.getNextSourceNode(!0,null,e.root),this._.lastNode&&this._.lastNode.type==CKEDITOR.NODE_TEXT&&!CKEDITOR.tools.trim(this._.lastNode.getText())&&this._.lastNode.getParent().isBlockBoundary()&&(c=this.range.clone(),c.moveToPosition(this._.lastNode,CKEDITOR.POSITION_AFTER_END),c.checkEndOfBlock()&&
(c=new CKEDITOR.dom.elementPath(c.endContainer,c.root),this._.lastNode=(c.block||c.blockLimit).getNextSourceNode(!0))),this._.lastNode&&e.root.contains(this._.lastNode)||(this._.lastNode=this._.docEndMarker=e.document.createText(""),this._.lastNode.insertAfter(b)),e=null);this._.started=1;b=e}c=this._.nextNode;e=this._.lastNode;for(this._.nextNode=null;c;){var h=0,q=c.hasAscendant("pre"),k=c.type!=CKEDITOR.NODE_ELEMENT,n=0;if(k)c.type==CKEDITOR.NODE_TEXT&&v.test(c.getText())&&(k=0);else{var l=c.getName();
if(CKEDITOR.dtd.$block[l]&&"false"==c.getAttribute("contenteditable")){a=c;r(this,d,a);break}else if(c.isBlockBoundary(this.forceBrBreak&&!q&&{br:1})){if("br"==l)k=1;else if(!b&&!c.getChildCount()&&"hr"!=l){a=c;f=c.equals(e);break}b&&(b.setEndAt(c,CKEDITOR.POSITION_BEFORE_START),"br"!=l&&(this._.nextNode=c));h=1}else{if(c.getFirst()){b||(b=this.range.clone(),b.setStartAt(c,CKEDITOR.POSITION_BEFORE_START));c=c.getFirst();continue}k=1}}k&&!b&&(b=this.range.clone(),b.setStartAt(c,CKEDITOR.POSITION_BEFORE_START));
f=(!h||k)&&c.equals(e);if(b&&!h)for(;!c.getNext(x)&&!f;){l=c.getParent();if(l.isBlockBoundary(this.forceBrBreak&&!q&&{br:1})){h=1;k=0;f||l.equals(e);b.setEndAt(l,CKEDITOR.POSITION_BEFORE_END);break}c=l;k=1;f=c.equals(e);n=1}k&&b.setEndAt(c,CKEDITOR.POSITION_AFTER_END);c=this._getNextSourceNode(c,n,e);if((f=!c)||h&&b)break}if(!a){if(!b)return this._.docEndMarker&&this._.docEndMarker.remove(),this._.nextNode=null;a=new CKEDITOR.dom.elementPath(b.startContainer,b.root);c=a.blockLimit;h={div:1,th:1,td:1};
a=a.block;!a&&c&&!this.enforceRealBlocks&&h[c.getName()]&&b.checkStartOfBlock()&&b.checkEndOfBlock()&&!c.equals(b.root)?a=c:!a||this.enforceRealBlocks&&a.is(y)?(a=this.range.document.createElement(d),b.extractContents().appendTo(a),a.trim(),b.insertNode(a),g=m=!0):"li"!=a.getName()?b.checkStartOfBlock()&&b.checkEndOfBlock()||(a=a.clone(!1),b.extractContents().appendTo(a),a.trim(),m=b.splitBlock(),g=!m.wasStartOfBlock,m=!m.wasEndOfBlock,b.insertNode(a)):f||(this._.nextNode=a.equals(e)?null:this._getNextSourceNode(b.getBoundaryNodes().endNode,
1,e))}g&&(g=a.getPrevious())&&g.type==CKEDITOR.NODE_ELEMENT&&("br"==g.getName()?g.remove():g.getLast()&&"br"==g.getLast().$.nodeName.toLowerCase()&&g.getLast().remove());m&&(g=a.getLast())&&g.type==CKEDITOR.NODE_ELEMENT&&"br"==g.getName()&&(!CKEDITOR.env.needsBrFiller||g.getPrevious(p)||g.getNext(p))&&g.remove();this._.nextNode||(this._.nextNode=f||a.equals(e)||!e?null:this._getNextSourceNode(a,1,e));return a},_getNextSourceNode:function(d,a,b){function f(a){return!(a.equals(b)||a.equals(g))}var g=
this.range.root;for(d=d.getNextSourceNode(a,null,f);!p(d);)d=d.getNextSourceNode(a,null,f);return d}};CKEDITOR.dom.range.prototype.createIterator=function(){return new n(this)}})();