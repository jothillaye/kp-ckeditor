/*
 Copyright (c) 2003-2017, CKSource - Frederico Knabben. All rights reserved.
 For licensing, see LICENSE.md or http://ckeditor.com/license
*/
(function(){function r(a,c){if(0===a.length)return!1;var b,d;if((b=!c&&1===a.length)&&!(b=a[0].collapsed)){var f=a[0];b=f.startContainer.getAscendant({td:1,th:1},!0);var g=f.endContainer.getAscendant({td:1,th:1},!0);d=CKEDITOR.tools.trim;b&&b.equals(g)&&!b.findOne("td, th, tr, tbody, table")?(f=f.cloneContents(),b=f.getFirst()?d(f.getFirst().getText())!==d(b.getText()):!0):b=!1}if(b)return!1;for(d=0;d<a.length;d++)if(b=a[d]._getTableElement(),!b)return!1;return!0}function K(a){function c(b){b=b.find("td, th");
var a=[],c;for(c=0;c<b.count();c++)a.push(b.getItem(c));return a}var b=[],d,f;for(f=0;f<a.length;f++)d=a[f]._getTableElement(),d.is&&d.is({td:1,th:1})?b.push(d):b=b.concat(c(d));return b}function L(a){a=K(a);var c="",b=[],d,f;for(f=0;f<a.length;f++)d&&!d.equals(a[f].getAscendant("tr"))?(c+=b.join("\t")+"\n",d=a[f].getAscendant("tr"),b=[]):0===f&&(d=a[f].getAscendant("tr")),b.push(a[f].getText());return c+=b.join("\t")}function G(a){var c=this.root.editor,b=c.getSelection(1);this.reset();B=!0;b.root.once("selectionchange",
function(b){b.cancel()},null,null,0);b.selectRanges([a[0]]);b=this._.cache;b.ranges=new CKEDITOR.dom.rangeList(a);b.type=CKEDITOR.SELECTION_TEXT;b.selectedElement=a[0]._getTableElement();b.selectedText=L(a);b.nativeSel=null;this.isFake=1;this.rev=y++;c._.fakeSelection=this;B=!1;this.root.fire("selectionchange")}function C(){var a=this._.fakeSelection,c;if(a){c=this.getSelection(1);var b;if(!(b=!c)&&(b=!c.isHidden())){b=a;var d=c.getRanges(),f=b.getRanges(),g=d.length&&d[0]._getTableElement()&&d[0]._getTableElement().getAscendant("table",
!0),h=f.length&&f[0]._getTableElement()&&f[0]._getTableElement().getAscendant("table",!0),l=1===d.length&&d[0]._getTableElement()&&d[0]._getTableElement().is("table"),e=1===f.length&&f[0]._getTableElement()&&f[0]._getTableElement().is("table"),k=1===d.length&&d[0].collapsed,f=r(d,!!CKEDITOR.env.webkit)&&r(f);g=g&&h?g.equals(h)||h.contains(g):!1;g&&(k||f)?(l&&!e&&b.selectRanges(d),b=!0):b=!1;b=!b}b&&(a.reset(),a=0)}if(!a&&(a=c||this.getSelection(1),!a||a.getType()==CKEDITOR.SELECTION_NONE))return;
this.fire("selectionCheck",a);c=this.elementPath();c.compare(this._.selectionPreviousPath)||(b=this._.selectionPreviousPath&&this._.selectionPreviousPath.blockLimit.equals(c.blockLimit),CKEDITOR.env.webkit&&!b&&(this._.previousActive=this.document.getActive()),this._.selectionPreviousPath=c,this.fire("selectionChange",{selection:a,path:c}))}function z(){D=!0;E||(H.call(this),E=CKEDITOR.tools.setTimeout(H,200,this))}function H(){E=null;D&&(CKEDITOR.tools.setTimeout(C,0,this),D=!1)}function I(a){return M(a)||
a.type==CKEDITOR.NODE_ELEMENT&&!a.is(CKEDITOR.dtd.$empty)?!0:!1}function N(a){function c(b,c){return b&&b.type!=CKEDITOR.NODE_TEXT?a.clone()["moveToElementEdit"+(c?"End":"Start")](b):!1}if(!(a.root instanceof CKEDITOR.editable))return!1;var b=a.startContainer,d=a.getPreviousNode(I,null,b),f=a.getNextNode(I,null,b);return c(d)||c(f,1)||!(d||f||b.type==CKEDITOR.NODE_ELEMENT&&b.isBlockBoundary()&&b.getBogus())?!0:!1}function J(a){x(a,!1);var c=a.getDocument().createText(u);a.setCustomData("cke-fillingChar",
c);return c}function x(a,c){var b=a&&a.removeCustomData("cke-fillingChar");if(b){if(!1!==c){var d=a.getDocument().getSelection().getNative(),f=d&&"None"!=d.type&&d.getRangeAt(0),g=u.length;if(b.getLength()>g&&f&&f.intersectsNode(b.$)){var h=[{node:d.anchorNode,offset:d.anchorOffset},{node:d.focusNode,offset:d.focusOffset}];d.anchorNode==b.$&&d.anchorOffset>g&&(h[0].offset-=g);d.focusNode==b.$&&d.focusOffset>g&&(h[1].offset-=g)}}b.setText(A(b.getText(),1));h&&(b=a.getDocument().$,d=b.getSelection(),
b=b.createRange(),b.setStart(h[0].node,h[0].offset),b.collapse(!0),d.removeAllRanges(),d.addRange(b),d.extend(h[1].node,h[1].offset))}}function A(a,c){return c?a.replace(O,function(b,a){return a?" ":""}):a.replace(u,"")}function P(a,c){var b=CKEDITOR.dom.element.createFromHtml('\x3cdiv data-cke-hidden-sel\x3d"1" data-cke-temp\x3d"1" style\x3d"'+(CKEDITOR.env.ie&&14>CKEDITOR.env.version?"display:none":"position:fixed;top:0;left:-1000px")+'"\x3e'+(c||"\x26nbsp;")+"\x3c/div\x3e",a.document);a.fire("lockSnapshot");
a.editable().append(b);var d=a.getSelection(1),f=a.createRange(),g=d.root.on("selectionchange",function(b){b.cancel()},null,null,0);f.setStartAt(b,CKEDITOR.POSITION_AFTER_START);f.setEndAt(b,CKEDITOR.POSITION_BEFORE_END);d.selectRanges([f]);g.removeListener();a.fire("unlockSnapshot");a._.hiddenSelectionContainer=b}function Q(a){var c={37:1,39:1,8:1,46:1};return function(b){var d=b.data.getKeystroke();if(c[d]){var f=a.getSelection().getRanges(),g=f[0];1==f.length&&g.collapsed&&(d=g[38>d?"getPreviousEditableNode":
"getNextEditableNode"]())&&d.type==CKEDITOR.NODE_ELEMENT&&"false"==d.getAttribute("contenteditable")&&(a.getSelection().fake(d),b.data.preventDefault(),b.cancel())}}}function R(a){for(var c=0;c<a.length;c++){var b=a[c];b.getCommonAncestor().isReadOnly()&&a.splice(c,1);if(!b.collapsed){if(b.startContainer.isReadOnly())for(var d=b.startContainer,f;d&&!((f=d.type==CKEDITOR.NODE_ELEMENT)&&d.is("body")||!d.isReadOnly());)f&&"false"==d.getAttribute("contentEditable")&&b.setStartAfter(d),d=d.getParent();
d=b.startContainer;f=b.endContainer;var g=b.startOffset,h=b.endOffset,l=b.clone();d&&d.type==CKEDITOR.NODE_TEXT&&(g>=d.getLength()?l.setStartAfter(d):l.setStartBefore(d));f&&f.type==CKEDITOR.NODE_TEXT&&(h?l.setEndAfter(f):l.setEndBefore(f));d=new CKEDITOR.dom.walker(l);d.evaluator=function(d){if(d.type==CKEDITOR.NODE_ELEMENT&&d.isReadOnly()){var f=b.clone();b.setEndBefore(d);b.collapsed&&a.splice(c--,1);d.getPosition(l.endContainer)&CKEDITOR.POSITION_CONTAINS||(f.setStartAfter(d),f.collapsed||a.splice(c+
1,0,f));return!0}return!1};d.next()}}return a}var v="function"!=typeof window.getSelection,y=1,u=CKEDITOR.tools.repeat("​",7),O=new RegExp(u+"( )?","g"),B,E,D,M=CKEDITOR.dom.walker.invisible(1),S=function(){function a(b){return function(a){var c=a.editor.createRange();c.moveToClosestEditablePosition(a.selected,b)&&a.editor.getSelection().selectRanges([c]);return!1}}function c(b){return function(a){var c=a.editor,d=c.createRange(),e;(e=d.moveToClosestEditablePosition(a.selected,b))||(e=d.moveToClosestEditablePosition(a.selected,
!b));e&&c.getSelection().selectRanges([d]);c.fire("saveSnapshot");a.selected.remove();e||(d.moveToElementEditablePosition(c.editable()),c.getSelection().selectRanges([d]));c.fire("saveSnapshot");return!1}}var b=a(),d=a(1);return{37:b,38:b,39:d,40:d,8:c(),46:c(1)}}();CKEDITOR.on("instanceCreated",function(a){function c(){var a=b.getSelection();a&&a.removeAllRanges()}var b=a.editor;b.on("contentDom",function(){function a(){p=new CKEDITOR.dom.selection(b.getSelection());p.lock()}function c(){l.removeListener("mouseup",
c);m.removeListener("mouseup",c);var a=CKEDITOR.document.$.selection,b=a.createRange();"None"!=a.type&&b.parentElement()&&b.parentElement().ownerDocument==h.$&&b.select()}function g(a){if(CKEDITOR.env.ie){var b=(a=a.getRanges()[0])?a.startContainer.getAscendant(function(a){return a.type==CKEDITOR.NODE_ELEMENT&&("false"==a.getAttribute("contenteditable")||"true"==a.getAttribute("contenteditable"))},!0):null;return a&&"false"==b.getAttribute("contenteditable")&&b}}var h=b.document,l=CKEDITOR.document,
e=b.editable(),k=h.getBody(),m=h.getDocumentElement(),n=e.isInline(),q,p;CKEDITOR.env.gecko&&e.attachListener(e,"focus",function(a){a.removeListener();0!==q&&(a=b.getSelection().getNative())&&a.isCollapsed&&a.anchorNode==e.$&&(a=b.createRange(),a.moveToElementEditStart(e),a.select())},null,null,-2);e.attachListener(e,CKEDITOR.env.webkit?"DOMFocusIn":"focus",function(){q&&CKEDITOR.env.webkit&&(q=b._.previousActive&&b._.previousActive.equals(h.getActive()))&&null!=b._.previousScrollTop&&b._.previousScrollTop!=
e.$.scrollTop&&(e.$.scrollTop=b._.previousScrollTop);b.unlockSelection(q);q=0},null,null,-1);e.attachListener(e,"mousedown",function(){q=0});if(CKEDITOR.env.ie||n)v?e.attachListener(e,"beforedeactivate",a,null,null,-1):e.attachListener(b,"selectionCheck",a,null,null,-1),e.attachListener(e,CKEDITOR.env.webkit?"DOMFocusOut":"blur",function(){b.lockSelection(p);q=1},null,null,-1),e.attachListener(e,"mousedown",function(){q=0});if(CKEDITOR.env.ie&&!n){var t;e.attachListener(e,"mousedown",function(a){2==
a.data.$.button&&((a=b.document.getSelection())&&a.getType()!=CKEDITOR.SELECTION_NONE||(t=b.window.getScrollPosition()))});e.attachListener(e,"mouseup",function(a){2==a.data.$.button&&t&&(b.document.$.documentElement.scrollLeft=t.x,b.document.$.documentElement.scrollTop=t.y);t=null});if("BackCompat"!=h.$.compatMode){if(CKEDITOR.env.ie7Compat||CKEDITOR.env.ie6Compat){var w,r;m.on("mousedown",function(a){function b(a){a=a.data.$;if(w){var c=k.$.createTextRange();try{c.moveToPoint(a.clientX,a.clientY)}catch(d){}w.setEndPoint(0>
r.compareEndPoints("StartToStart",c)?"EndToEnd":"StartToStart",c);w.select()}}function c(){m.removeListener("mousemove",b);l.removeListener("mouseup",c);m.removeListener("mouseup",c);w.select()}a=a.data;if(a.getTarget().is("html")&&a.$.y<m.$.clientHeight&&a.$.x<m.$.clientWidth){w=k.$.createTextRange();try{w.moveToPoint(a.$.clientX,a.$.clientY)}catch(d){}r=w.duplicate();m.on("mousemove",b);l.on("mouseup",c);m.on("mouseup",c)}})}if(7<CKEDITOR.env.version&&11>CKEDITOR.env.version)m.on("mousedown",function(a){a.data.getTarget().is("html")&&
(l.on("mouseup",c),m.on("mouseup",c))})}}e.attachListener(e,"selectionchange",C,b);e.attachListener(e,"keyup",z,b);e.attachListener(e,"keydown",function(a){var b=this.getSelection(1);g(b)&&(b.selectElement(g(b)),a.data.preventDefault())},b);e.attachListener(e,CKEDITOR.env.webkit?"DOMFocusIn":"focus",function(){b.forceNextSelectionCheck();b.selectionChange(1)});if(n&&(CKEDITOR.env.webkit||CKEDITOR.env.gecko)){var u;e.attachListener(e,"mousedown",function(){u=1});e.attachListener(h.getDocumentElement(),
"mouseup",function(){u&&z.call(b);u=0})}else e.attachListener(CKEDITOR.env.ie?e:h.getDocumentElement(),"mouseup",z,b);CKEDITOR.env.webkit&&e.attachListener(h,"keydown",function(a){switch(a.data.getKey()){case 13:case 33:case 34:case 35:case 36:case 37:case 39:case 8:case 45:case 46:e.hasFocus&&x(e)}},null,null,-1);e.attachListener(e,"keydown",Q(b),null,null,-1)});b.on("setData",function(){b.unlockSelection();CKEDITOR.env.webkit&&c()});b.on("contentDomUnload",function(){b.unlockSelection()});if(CKEDITOR.env.ie9Compat)b.on("beforeDestroy",
c,null,null,9);b.on("dataReady",function(){delete b._.fakeSelection;delete b._.hiddenSelectionContainer;b.selectionChange(1)});b.on("loadSnapshot",function(){var a=CKEDITOR.dom.walker.nodeType(CKEDITOR.NODE_ELEMENT),c=b.editable().getLast(a);c&&c.hasAttribute("data-cke-hidden-sel")&&(c.remove(),CKEDITOR.env.gecko&&(a=b.editable().getFirst(a))&&a.is("br")&&a.getAttribute("_moz_editor_bogus_node")&&a.remove())},null,null,100);b.on("key",function(a){if("wysiwyg"==b.mode){var c=b.getSelection();if(c.isFake){var g=
S[a.data.keyCode];if(g)return g({editor:b,selected:c.getSelectedElement(),selection:c,keyEvent:a})}}})});if(CKEDITOR.env.webkit)CKEDITOR.on("instanceReady",function(a){var c=a.editor;c.on("selectionChange",function(){var a=c.editable(),d=a.getCustomData("cke-fillingChar");d&&(d.getCustomData("ready")?(x(a),a.editor.fire("selectionCheck")):d.setCustomData("ready",1))},null,null,-1);c.on("beforeSetMode",function(){x(c.editable())},null,null,-1);c.on("getSnapshot",function(a){a.data&&(a.data=A(a.data))},
c,null,20);c.on("toDataFormat",function(a){a.data.dataValue=A(a.data.dataValue)},null,null,0)});CKEDITOR.editor.prototype.selectionChange=function(a){(a?C:z).call(this)};CKEDITOR.editor.prototype.getSelection=function(a){return!this._.savedSelection&&!this._.fakeSelection||a?(a=this.editable())&&"wysiwyg"==this.mode?new CKEDITOR.dom.selection(a):null:this._.savedSelection||this._.fakeSelection};CKEDITOR.editor.prototype.lockSelection=function(a){a=a||this.getSelection(1);return a.getType()!=CKEDITOR.SELECTION_NONE?
(!a.isLocked&&a.lock(),this._.savedSelection=a,!0):!1};CKEDITOR.editor.prototype.unlockSelection=function(a){var c=this._.savedSelection;return c?(c.unlock(a),delete this._.savedSelection,!0):!1};CKEDITOR.editor.prototype.forceNextSelectionCheck=function(){delete this._.selectionPreviousPath};CKEDITOR.dom.document.prototype.getSelection=function(){return new CKEDITOR.dom.selection(this)};CKEDITOR.dom.range.prototype.select=function(){var a=this.root instanceof CKEDITOR.editable?this.root.editor.getSelection():
new CKEDITOR.dom.selection(this.root);a.selectRanges([this]);return a};CKEDITOR.SELECTION_NONE=1;CKEDITOR.SELECTION_TEXT=2;CKEDITOR.SELECTION_ELEMENT=3;CKEDITOR.dom.selection=function(a){if(a instanceof CKEDITOR.dom.selection){var c=a;a=a.root}var b=a instanceof CKEDITOR.dom.element;this.rev=c?c.rev:y++;this.document=a instanceof CKEDITOR.dom.document?a:a.getDocument();this.root=b?a:this.document.getBody();this.isLocked=0;this._={cache:{}};if(c)return CKEDITOR.tools.extend(this._.cache,c._.cache),
this.isFake=c.isFake,this.isLocked=c.isLocked,this;a=this.getNative();var d,f;if(a)if(a.getRangeAt)d=(f=a.rangeCount&&a.getRangeAt(0))&&new CKEDITOR.dom.node(f.commonAncestorContainer);else{try{f=a.createRange()}catch(g){}d=f&&CKEDITOR.dom.element.get(f.item&&f.item(0)||f.parentElement())}if(!d||d.type!=CKEDITOR.NODE_ELEMENT&&d.type!=CKEDITOR.NODE_TEXT||!this.root.equals(d)&&!this.root.contains(d))this._.cache.type=CKEDITOR.SELECTION_NONE,this._.cache.startElement=null,this._.cache.selectedElement=
null,this._.cache.selectedText="",this._.cache.ranges=new CKEDITOR.dom.rangeList;return this};var F={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};CKEDITOR.tools.extend(CKEDITOR.dom.selection,{_removeFillingCharSequenceString:A,_createFillingCharSequenceNode:J,FILLING_CHAR_SEQUENCE:u});CKEDITOR.dom.selection.prototype={getNative:function(){return void 0!==this._.cache.nativeSel?this._.cache.nativeSel:this._.cache.nativeSel=
v?this.document.$.selection:this.document.getWindow().$.getSelection()},getType:v?function(){var a=this._.cache;if(a.type)return a.type;var c=CKEDITOR.SELECTION_NONE;try{var b=this.getNative(),d=b.type;"Text"==d&&(c=CKEDITOR.SELECTION_TEXT);"Control"==d&&(c=CKEDITOR.SELECTION_ELEMENT);b.createRange().parentElement()&&(c=CKEDITOR.SELECTION_TEXT)}catch(f){}return a.type=c}:function(){var a=this._.cache;if(a.type)return a.type;var c=CKEDITOR.SELECTION_TEXT,b=this.getNative();if(!b||!b.rangeCount)c=CKEDITOR.SELECTION_NONE;
else if(1==b.rangeCount){var b=b.getRangeAt(0),d=b.startContainer;d==b.endContainer&&1==d.nodeType&&1==b.endOffset-b.startOffset&&F[d.childNodes[b.startOffset].nodeName.toLowerCase()]&&(c=CKEDITOR.SELECTION_ELEMENT)}return a.type=c},getRanges:function(){var a=v?function(){function a(b){return(new CKEDITOR.dom.node(b)).getIndex()}var b=function(b,f){b=b.duplicate();b.collapse(f);var g=b.parentElement();if(!g.hasChildNodes())return{container:g,offset:0};for(var h=g.children,l,e,k=b.duplicate(),m=0,
n=h.length-1,q=-1,p,t;m<=n;)if(q=Math.floor((m+n)/2),l=h[q],k.moveToElementText(l),p=k.compareEndPoints("StartToStart",b),0<p)n=q-1;else if(0>p)m=q+1;else return{container:g,offset:a(l)};if(-1==q||q==h.length-1&&0>p){k.moveToElementText(g);k.setEndPoint("StartToStart",b);k=k.text.replace(/(\r\n|\r)/g,"\n").length;h=g.childNodes;if(!k)return l=h[h.length-1],l.nodeType!=CKEDITOR.NODE_TEXT?{container:g,offset:h.length}:{container:l,offset:l.nodeValue.length};for(g=h.length;0<k&&0<g;)e=h[--g],e.nodeType==
CKEDITOR.NODE_TEXT&&(t=e,k-=e.nodeValue.length);return{container:t,offset:-k}}k.collapse(0<p?!0:!1);k.setEndPoint(0<p?"StartToStart":"EndToStart",b);k=k.text.replace(/(\r\n|\r)/g,"\n").length;if(!k)return{container:g,offset:a(l)+(0<p?0:1)};for(;0<k;)try{e=l[0<p?"previousSibling":"nextSibling"],e.nodeType==CKEDITOR.NODE_TEXT&&(k-=e.nodeValue.length,t=e),l=e}catch(r){return{container:g,offset:a(l)}}return{container:t,offset:0<p?-k:t.nodeValue.length+k}};return function(){var a=this.getNative(),c=a&&
a.createRange(),g=this.getType();if(!a)return[];if(g==CKEDITOR.SELECTION_TEXT)return a=new CKEDITOR.dom.range(this.root),g=b(c,!0),a.setStart(new CKEDITOR.dom.node(g.container),g.offset),g=b(c),a.setEnd(new CKEDITOR.dom.node(g.container),g.offset),a.endContainer.getPosition(a.startContainer)&CKEDITOR.POSITION_PRECEDING&&a.endOffset<=a.startContainer.getIndex()&&a.collapse(),[a];if(g==CKEDITOR.SELECTION_ELEMENT){for(var g=[],h=0;h<c.length;h++){for(var l=c.item(h),e=l.parentNode,k=0,a=new CKEDITOR.dom.range(this.root);k<
e.childNodes.length&&e.childNodes[k]!=l;k++);a.setStart(new CKEDITOR.dom.node(e),k);a.setEnd(new CKEDITOR.dom.node(e),k+1);g.push(a)}return g}return[]}}():function(){var a=[],b,d=this.getNative();if(!d)return a;for(var f=0;f<d.rangeCount;f++){var g=d.getRangeAt(f);b=new CKEDITOR.dom.range(this.root);b.setStart(new CKEDITOR.dom.node(g.startContainer),g.startOffset);b.setEnd(new CKEDITOR.dom.node(g.endContainer),g.endOffset);a.push(b)}return a};return function(c){var b=this._.cache,d=b.ranges;d||(b.ranges=
d=new CKEDITOR.dom.rangeList(a.call(this)));return c?R(new CKEDITOR.dom.rangeList(d.slice())):d}}(),getStartElement:function(){var a=this._.cache;if(void 0!==a.startElement)return a.startElement;var c;switch(this.getType()){case CKEDITOR.SELECTION_ELEMENT:return this.getSelectedElement();case CKEDITOR.SELECTION_TEXT:var b=this.getRanges()[0];if(b){if(b.collapsed)c=b.startContainer,c.type!=CKEDITOR.NODE_ELEMENT&&(c=c.getParent());else{for(b.optimize();c=b.startContainer,b.startOffset==(c.getChildCount?
c.getChildCount():c.getLength())&&!c.isBlockBoundary();)b.setStartAfter(c);c=b.startContainer;if(c.type!=CKEDITOR.NODE_ELEMENT)return c.getParent();if((c=c.getChild(b.startOffset))&&c.type==CKEDITOR.NODE_ELEMENT)for(b=c.getFirst();b&&b.type==CKEDITOR.NODE_ELEMENT;)c=b,b=b.getFirst();else c=b.startContainer}c=c.$}}return a.startElement=c?new CKEDITOR.dom.element(c):null},getSelectedElement:function(){var a=this._.cache;if(void 0!==a.selectedElement)return a.selectedElement;var c=this,b=CKEDITOR.tools.tryThese(function(){return c.getNative().createRange().item(0)},
function(){for(var a=c.getRanges()[0].clone(),b,g,h=2;h&&!((b=a.getEnclosedNode())&&b.type==CKEDITOR.NODE_ELEMENT&&F[b.getName()]&&(g=b));h--)a.shrink(CKEDITOR.SHRINK_ELEMENT);return g&&g.$});return a.selectedElement=b?new CKEDITOR.dom.element(b):null},getSelectedText:function(){var a=this._.cache;if(void 0!==a.selectedText)return a.selectedText;var c=this.getNative(),c=v?"Control"==c.type?"":c.createRange().text:c.toString();return a.selectedText=c},lock:function(){this.getRanges();this.getStartElement();
this.getSelectedElement();this.getSelectedText();this._.cache.nativeSel=null;this.isLocked=1},unlock:function(a){if(this.isLocked){if(a)var c=this.getSelectedElement(),b=this.getRanges(),d=this.isFake;this.isLocked=0;this.reset();a&&(a=c||b[0]&&b[0].getCommonAncestor())&&a.getAscendant("body",1)&&(r(b)?G.call(this,b):d?this.fake(c):c?this.selectElement(c):this.selectRanges(b))}},reset:function(){this._.cache={};this.isFake=0;var a=this.root.editor;if(a&&a._.fakeSelection)if(this.rev==a._.fakeSelection.rev){delete a._.fakeSelection;
var c=a._.hiddenSelectionContainer;if(c){var b=a.checkDirty();a.fire("lockSnapshot");c.remove();a.fire("unlockSnapshot");!b&&a.resetDirty()}delete a._.hiddenSelectionContainer}else CKEDITOR.warn("selection-fake-reset");this.rev=y++},selectElement:function(a){var c=new CKEDITOR.dom.range(this.root);c.setStartBefore(a);c.setEndAfter(a);this.selectRanges([c])},selectRanges:function(a){var c=this.root.editor,b=c&&c._.hiddenSelectionContainer;this.reset();if(b)for(var b=this.root,d,f=0;f<a.length;++f)d=
a[f],d.endContainer.equals(b)&&(d.endOffset=Math.min(d.endOffset,b.getChildCount()));if(a.length)if(this.isLocked){var g=CKEDITOR.document.getActive();this.unlock();this.selectRanges(a);this.lock();g&&!g.equals(this.root)&&g.focus()}else{var h;a:{var l,e;if(1==a.length&&!(e=a[0]).collapsed&&(h=e.getEnclosedNode())&&h.type==CKEDITOR.NODE_ELEMENT&&(e=e.clone(),e.shrink(CKEDITOR.SHRINK_ELEMENT,!0),(l=e.getEnclosedNode())&&l.type==CKEDITOR.NODE_ELEMENT&&(h=l),"false"==h.getAttribute("contenteditable")))break a;
h=void 0}if(h)this.fake(h);else if(c&&c.plugins.tableselection&&CKEDITOR.plugins.tableselection.isSupportedEnvironment&&r(a)&&!B)G.call(this,a);else{if(v){l=CKEDITOR.dom.walker.whitespaces(!0);h=/\ufeff|\u00a0/;e={table:1,tbody:1,tr:1};1<a.length&&(c=a[a.length-1],a[0].setEnd(c.endContainer,c.endOffset));c=a[0];a=c.collapsed;var k,m,n;if((b=c.getEnclosedNode())&&b.type==CKEDITOR.NODE_ELEMENT&&b.getName()in F&&(!b.is("a")||!b.getText()))try{n=b.$.createControlRange();n.addElement(b.$);n.select();return}catch(q){}if(c.startContainer.type==
CKEDITOR.NODE_ELEMENT&&c.startContainer.getName()in e||c.endContainer.type==CKEDITOR.NODE_ELEMENT&&c.endContainer.getName()in e)c.shrink(CKEDITOR.NODE_ELEMENT,!0),a=c.collapsed;n=c.createBookmark();e=n.startNode;a||(g=n.endNode);n=c.document.$.body.createTextRange();n.moveToElementText(e.$);n.moveStart("character",1);g?(h=c.document.$.body.createTextRange(),h.moveToElementText(g.$),n.setEndPoint("EndToEnd",h),n.moveEnd("character",-1)):(k=e.getNext(l),m=e.hasAscendant("pre"),k=!(k&&k.getText&&k.getText().match(h))&&
(m||!e.hasPrevious()||e.getPrevious().is&&e.getPrevious().is("br")),m=c.document.createElement("span"),m.setHtml("\x26#65279;"),m.insertBefore(e),k&&c.document.createText("﻿").insertBefore(e));c.setStartBefore(e);e.remove();a?(k?(n.moveStart("character",-1),n.select(),c.document.$.selection.clear()):n.select(),c.moveToPosition(m,CKEDITOR.POSITION_BEFORE_START),m.remove()):(c.setEndBefore(g),g.remove(),n.select())}else{g=this.getNative();if(!g)return;this.removeAllRanges();for(n=0;n<a.length;n++){if(n<
a.length-1&&(k=a[n],m=a[n+1],h=k.clone(),h.setStart(k.endContainer,k.endOffset),h.setEnd(m.startContainer,m.startOffset),!h.collapsed&&(h.shrink(CKEDITOR.NODE_ELEMENT,!0),c=h.getCommonAncestor(),h=h.getEnclosedNode(),c.isReadOnly()||h&&h.isReadOnly()))){m.setStart(k.startContainer,k.startOffset);a.splice(n--,1);continue}c=a[n];m=this.document.$.createRange();c.collapsed&&CKEDITOR.env.webkit&&N(c)&&(h=J(this.root),c.insertNode(h),(k=h.getNext())&&!h.getPrevious()&&k.type==CKEDITOR.NODE_ELEMENT&&"br"==
k.getName()?(x(this.root),c.moveToPosition(k,CKEDITOR.POSITION_BEFORE_START)):c.moveToPosition(h,CKEDITOR.POSITION_AFTER_END));m.setStart(c.startContainer.$,c.startOffset);try{m.setEnd(c.endContainer.$,c.endOffset)}catch(p){if(0<=p.toString().indexOf("NS_ERROR_ILLEGAL_VALUE"))c.collapse(1),m.setEnd(c.endContainer.$,c.endOffset);else throw p;}g.addRange(m)}}this.reset();this.root.fire("selectionchange")}}},fake:function(a,c){var b=this.root.editor;void 0===c&&a.hasAttribute("aria-label")&&(c=a.getAttribute("aria-label"));
this.reset();P(b,c);var d=this._.cache,f=new CKEDITOR.dom.range(this.root);f.setStartBefore(a);f.setEndAfter(a);d.ranges=new CKEDITOR.dom.rangeList(f);d.selectedElement=d.startElement=a;d.type=CKEDITOR.SELECTION_ELEMENT;d.selectedText=d.nativeSel=null;this.isFake=1;this.rev=y++;b._.fakeSelection=this;this.root.fire("selectionchange")},isHidden:function(){var a=this.getCommonAncestor();a&&a.type==CKEDITOR.NODE_TEXT&&(a=a.getParent());return!(!a||!a.data("cke-hidden-sel"))},isInTable:function(a){return r(this.getRanges(),
a)},isCollapsed:function(){var a=this.getRanges();return 1===a.length&&a[0].collapsed},createBookmarks:function(a){a=this.getRanges().createBookmarks(a);this.isFake&&(a.isFake=1);return a},createBookmarks2:function(a){a=this.getRanges().createBookmarks2(a);this.isFake&&(a.isFake=1);return a},selectBookmarks:function(a){for(var c=[],b,d=0;d<a.length;d++){var f=new CKEDITOR.dom.range(this.root);f.moveToBookmark(a[d]);c.push(f)}a.isFake&&(b=r(c)?c[0]._getTableElement():c[0].getEnclosedNode(),b&&b.type==
CKEDITOR.NODE_ELEMENT||(CKEDITOR.warn("selection-not-fake"),a.isFake=0));a.isFake&&!r(c)?this.fake(b):this.selectRanges(c);return this},getCommonAncestor:function(){var a=this.getRanges();return a.length?a[0].startContainer.getCommonAncestor(a[a.length-1].endContainer):null},scrollIntoView:function(){this.type!=CKEDITOR.SELECTION_NONE&&this.getRanges()[0].scrollIntoView()},removeAllRanges:function(){if(this.getType()!=CKEDITOR.SELECTION_NONE){var a=this.getNative();try{a&&a[v?"empty":"removeAllRanges"]()}catch(c){}this.reset()}}}})();